import MemoryService from "feathers-memory"
import request from "request-promise-native"

// API "Secrets". Feel free to steal them. I don't give a single F.
// TODO: Move that to Environment Variables, but I ain't got no time

const CHANNEL_TOKEN = "UuQd6RmSRQppG/0g6xc4Xh9GVigTR0/CqBV7afFJpYbRoMp0TGP00T1UNbEZmeDgM5VMEYF+ucWkGJwHwVoQP0cGzhAeg0RCToj8c2Pk2qCZI1/wkh6tTWlOtt9uFIMwKiqj5N/3bTCjfII3HQki3QdB04t89/1O/w1cDnyilFU="
const TEST_USER_ID = "U33084216cc1a00f7aa27632bec769356"

// SDK for interfacing with the LINE Messaging API
// NOTE: Why the heck are the Official SDKs deprecated? Like, seriously dude? -.-

const defaultAction = [{
  type: "postback",
  label: "à¸«à¸™à¸µà¹‰à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•",
  data: "action=buy&itemid=123"
}, {
  type: "postback",
  label: "à¸à¸à¸«à¸¡à¸²à¸¢à¸—à¸µà¹ˆà¸”à¸´à¸™",
  data: "action=add&itemid=123"
}]

const defaultImage = `https://images.unsplash.com/reserve/uvRBqDAfQfaGPJiI6lVS_R0001899.jpg?dpr=1&auto=format&fit=crop&w=1500&h=994&q=80&cs=tinysrgb&crop=`

class LineMessaging {

  constructor(token) {
    this.token = token;
  }

  post(endpoint, body) {
    request({
      method: "POST",
      uri: `https://api.line.me/v2/bot/${endpoint}`,
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(body)
    }).auth(null, null, true, this.token)
  }

  sendMessage(message, to = TEST_USER_ID) {
    this.post("message/push", {to, messages: [message]})
  }

  sendText(message, to) {
    if (Array.isArray(message)) {
      this.post("message/push", {
        to,
        messages: message.map(text => ({type: "text", text}))
      })
    } else {
      this.sendMessage({
        type: "text",
        text: `${message}`
      }, to)
    }
  }

  sendImage(url, to) {
    this.sendMessage({
      type: "image",
      originalContentUrl: url,
      previewImageUrl: `https://api.rethumb.com/v1/square/240/${url}`
    }, to)
  }

  sendTemplate({
    title, text, alt = "This is an alt text", thumbnail = defaultImage,
    actions = defaultAction
  }, to) {
    this.sendMessage({
      type: "template",
      altText: alt,
      template: {
        type: "buttons",
        thumbnailImageUrl: thumbnail,
        title,
        text,
        actions
      },
    }, to)
  }

}

const scripts = {
  "main": {}
}

const bot = new LineMessaging(CHANNEL_TOKEN)

class ChatStage extends MemoryService {
  // TODO: We need to store user's state in there.
  //       I'm thinking of Redis, but fuck it I'm tired.
  //       It's a hackathon, so yeah.
}

const initChat = id => {
  bot.sendTemplate({
    title: "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š à¸¡à¸µà¸­à¸°à¹„à¸£à¹ƒà¸«à¹‰à¸›à¸£à¸¶à¸à¸©à¸²à¹„à¸«à¸¡à¸„à¸£à¸±à¸š? ğŸ˜Š ğŸ‘Š",
    text: "à¸™à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹€à¸„à¸ªà¸—à¸µà¹ˆà¸à¸šà¸šà¹ˆà¸­à¸¢ à¸–à¹‰à¸²à¸ªà¸‡à¸ªà¸±à¸¢à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸à¸™à¸µà¹‰à¸–à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸™à¸°à¸„à¸£à¸±à¸š",
    alt: "Alt Message",
    thumbnail: "https://i.imgur.com/s4c7YSH.jpg",
    actions: [{
      type: "postback",
      label: "à¸«à¸™à¸µà¹‰à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸• ğŸ’³",
      data: "nomoney"
    }, {
      type: "postback",
      label: "à¹„à¸”à¹‰à¸«à¸¡à¸²à¸¢à¸¨à¸²à¸¥ âš–ï¸",
      data: "lawsuit"
    }, {
      type: "postback",
      label: "à¹‚à¸”à¸™à¸•à¸³à¸£à¸§à¸ˆà¸¢à¸¶à¸”à¸£à¸– ğŸš—",
      data: "policetookmycar"
    }, {
      type: "postback",
      label: "à¸–à¸¹à¸à¹à¸­à¸šà¸–à¹ˆà¸²à¸¢à¸¥à¸‡à¹‚à¸‹à¹€à¸Šà¸µà¸¢à¸¥ ğŸ“·",
      data: "paparazzis"
    }]
  }, id)
}

const REPLY = {
  "nomoney": [`à¹ƒà¸ˆà¹€à¸¢à¹‡à¸™à¹† à¹„à¸›à¸•à¸²à¸¡à¸¨à¸²à¸¥à¸™à¸±à¸” à¸„à¸¸à¸¢à¸à¸±à¸šà¸—à¸™à¸²à¸¢à¸‚à¸­à¸‡à¸˜à¸™à¸²à¸„à¸²à¸£à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡à¸šà¸±à¸•à¸£ à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸‚à¹‰à¸­à¹€à¸ªà¸™à¸­à¸‚à¸­à¸‡à¸˜à¸™à¸²à¸„à¸²à¸£à¸à¹ˆà¸­à¸™à¸™à¸° ğŸ˜‰`,
  `à¸–à¹‰à¸²à¹€à¸£à¸²à¹„à¸¡à¹ˆà¹„à¸«à¸§ à¸¥à¸­à¸‡à¸•à¹ˆà¸­à¸£à¸­à¸‡à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸·à¹ˆà¸­à¸™à¸§à¸±à¸™à¸ˆà¹ˆà¸²à¸¢à¹€à¸‡à¸´à¸™ à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸™à¸±à¹‰à¸™à¸—à¸²à¸‡à¸¨à¸²à¸¥à¸ˆà¸°à¹ƒà¸«à¹‰à¹€à¸‹à¹‡à¸™à¸ªà¸±à¸à¸à¸²à¹€à¸¥à¸·à¹ˆà¸­à¸™à¸§à¸±à¸™à¸™à¸±à¸”à¸„à¸”à¸µ à¹à¸¥à¹‰à¸§à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¹„à¸”à¹‰à¹€à¸¥à¸¢! ğŸ˜Š`,
  `à¹à¸•à¹ˆà¸–à¹‰à¸²à¹€à¸£à¸²à¹„à¸«à¸§ à¹€à¸•à¸£à¸µà¸¢à¸¡à¹€à¸­à¸à¸ªà¸²à¸£à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¹„à¸”à¹‰ à¹à¸¥à¹‰à¸§à¸à¹‡à¸•à¸à¸¥à¸‡à¸à¸±à¸šà¸˜à¸™à¸²à¸„à¸²à¸£à¹€à¸à¸·à¹ˆà¸­à¸œà¹ˆà¸­à¸™à¸Šà¸³à¸£à¸°à¸•à¸²à¸¡à¸£à¸²à¸¢à¹„à¸”à¹‰à¸—à¸µà¹ˆà¸¡à¸µ à¹à¸„à¹ˆà¸™à¸±à¹‰à¸™à¹€à¸­à¸‡~`,
  `à¸–à¹‰à¸²à¸—à¸²à¸‡à¸˜à¸™à¸²à¸„à¸²à¸£à¹€à¸„à¹‰à¸²à¸£à¸±à¸šà¹„à¸”à¹‰à¸à¹‡à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™ à¹à¸•à¹ˆà¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸à¹‡à¸•à¹‰à¸­à¸‡à¸¢à¸­à¸¡à¸—à¸³à¸•à¸²à¸¡à¸„à¸³à¸•à¸±à¸”à¸ªà¸´à¸™à¸‚à¸­à¸‡à¸¨à¸²à¸¥à¸¥à¹ˆà¸°à¸™à¸° ğŸ‘Š`],

  "policetookmycar": [
    `à¸–à¹‰à¸²à¸£à¸–à¹€à¸£à¸²à¸¢à¸±à¸‡à¸œà¹ˆà¸­à¸™à¹„à¸¡à¹ˆà¸«à¸¡à¸” à¸à¹‡à¹„à¸›à¸•à¸´à¸”à¸•à¹ˆà¸­à¹„à¸Ÿà¹à¸™à¸™à¸‹à¹Œà¹ƒà¸«à¹‰à¹€à¸„à¹‰à¸²à¸—à¸³à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹€à¸à¸·à¹ˆà¸­à¸‚à¸­à¸„à¸·à¸™ ğŸ˜¶`,
    `à¹à¸•à¹ˆà¸–à¹‰à¸²à¹€à¸£à¸²à¸œà¹ˆà¸­à¸™à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§ à¸à¹‡à¹„à¸›à¸¢à¸·à¹ˆà¸™à¸„à¸³à¸£à¹‰à¸­à¸‡à¸•à¹ˆà¸­à¸¨à¸²à¸¥à¸ à¸²à¸¢à¹ƒà¸™ 1 à¸›à¸µ à¹„à¸¡à¹ˆà¸­à¸¢à¹ˆà¸²à¸‡à¸™à¸±à¹‰à¸™à¸ˆà¸°à¸‚à¸¶à¹‰à¸™à¸§à¹ˆà¸²à¸ªà¸¹à¸à¸«à¸²à¸¢à¸™à¸° ğŸ˜‰`
  ],

  "paparazzis": `à¹ƒà¸ˆà¹€à¸¢à¹‡à¸™à¹† à¸à¹ˆà¸­à¸™ à¸£à¸µà¸šà¸£à¸§à¸šà¸£à¸§à¸¡à¸«à¸¥à¸±à¸à¸à¸²à¸™à¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™ à¹à¸¥à¹‰à¸§à¹„à¸›à¹€à¸‚à¹‰à¸²à¹à¸ˆà¹‰à¸‡à¸„à¸§à¸²à¸¡à¸à¸±à¸šà¸•à¸³à¸£à¸§à¸ˆà¸™à¸° ğŸ˜Š`,

  "P1": `à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸«à¸¡à¸²à¸¢à¹€à¸£à¸µà¸¢à¸à¹à¸¥à¸°à¸ªà¸³à¹€à¸™à¸²à¸„à¸³à¸Ÿà¹‰à¸­à¸‡ à¸«à¸£à¸·à¸­ à¸«à¸¡à¸²à¸¢à¹€à¸£à¸µà¸¢à¸à¸„à¸”à¸µà¹à¸à¹ˆà¸‡à¸ªà¸²à¸¡à¸±à¸
à¸•à¹ˆà¸­à¸—à¸³à¸à¸²à¸£à¸„à¸³à¹ƒà¸«à¹‰à¸à¸²à¸£à¸¢à¸·à¹ˆà¸™à¸•à¹ˆà¸­à¸¨à¸²à¸¥à¸ à¸²à¸¢à¹ƒà¸à¸³à¸«à¸™à¸” 15 à¸§à¸±à¸™ à¸™à¸±à¸šà¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸§à¸±à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸«à¸¡à¸²à¸¢`,

  "P2": [
    `à¸«à¸¡à¸²à¸¢à¹€à¸£à¸µà¸¢à¸à¸„à¸”à¸µà¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¢à¸¸à¹ˆà¸‡à¸¢à¸²à¸ à¸«à¸£à¸·à¸­ à¸«à¸¡à¸²à¸¢à¹€à¸£à¸µà¸¢à¸„à¸”à¸µà¸¡à¹‚à¸™à¸ªà¸²à¹€à¸«à¸£à¹ˆ`,
    `à¸„à¸”à¸µà¸¡à¹‚à¸™à¸ªà¸²à¹€à¸«à¸£à¹ˆ à¸„à¸·à¸­ à¸„à¸”à¸µà¸—à¸µà¹ˆà¸Ÿà¹‰à¸­à¸‡à¸£à¹‰à¸­à¸‡à¸à¸±à¸™à¹‚à¸”à¸¢à¸¡à¸µà¸—à¸¸à¸™à¸—à¸£à¸±à¸à¸¢à¹Œà¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 40,000 à¸šà¸²à¸—`,
    `à¹€à¸Šà¹ˆà¸™ à¸Ÿà¹‰à¸­à¸‡à¹„à¸¥à¹ˆà¸­à¸­à¸à¸ˆà¸²à¸à¸­à¸ªà¸±à¸‡à¸«à¸²à¸£à¸´à¸¡à¸—à¸£à¸±à¸à¸¢à¹Œ à¸—à¸µà¹ˆà¸¡à¸µà¸„à¹ˆà¸²à¹€à¸Šà¹ˆà¸²à¸‚à¸“à¸°à¸¢à¸·à¹ˆà¸™à¸Ÿà¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¸¥à¹ˆà¸° 4,000`,
    `à¸ˆà¸³à¹€à¸¥à¸¢à¸•à¹‰à¸­à¸‡à¸¡à¸²à¸¨à¸²à¸¥à¸•à¸²à¸¡à¸§à¸±à¸™à¸™à¸±à¸”à¹€à¸à¸·à¹ˆà¸­à¹„à¸à¸¥à¹ˆà¹€à¸à¸¥à¸µà¹ˆà¸¢`
  ],

  "A1": [
    `à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸”à¹‰à¸£à¸±à¸šà¸«à¸¡à¸²à¸¢à¸™à¸±à¸” à¸•à¹‰à¸­à¸‡à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸§à¹ˆà¸²à¸¨à¸²à¸¥à¸à¸³à¸«à¸™à¸”à¸§à¸±à¸™à¸™à¸±à¸”à¹„à¸•à¹ˆà¸ªà¸§à¸™à¸¡à¸¹à¸¥à¸Ÿà¹‰à¸­à¸‡à¸§à¸±à¸™à¹ƒà¸” âš–ï¸`,
    `à¸–à¹‰à¸²à¸ˆà¸°à¸•à¹ˆà¸­à¸ªà¸¹à¹‰à¸„à¸”à¸µà¸•à¹‰à¸­à¸‡à¸›à¸£à¸¶à¸à¸©à¸²à¸—à¸™à¸²à¸¢à¸„à¸§à¸²à¸¡à¸—à¸±à¸™à¸—à¸µ à¹€à¸à¸·à¹ˆà¸­à¸ˆà¸°à¸—à¸³à¸«à¸™à¸±à¸‡à¸ªà¸·à¸­à¹à¸•à¹ˆà¸‡à¸•à¸±à¹‰à¸‡à¹ƒà¸«à¹‰à¸—à¸™à¸²à¸¢à¹„à¸›à¸—à¸³à¸à¸²à¸£à¸‹à¸±à¸à¸„à¹‰à¸²à¸™à¸à¸¢à¸²à¸™à¹‚à¸ˆà¸—à¸à¹Œà¹ƒà¸™à¸§à¸±à¸™à¸™à¸±à¸”à¹„à¸•à¹ˆà¸ªà¸§à¸™à¸¡à¸¹à¸¥à¸Ÿà¹‰à¸­à¸‡à¹à¸—à¸™`,
    `à¹ƒà¸™à¸§à¸±à¸™à¸™à¸±à¸”à¹„à¸•à¹ˆà¸ªà¸§à¸™à¸¡à¸¹à¸¥à¸Ÿà¹‰à¸­à¸‡ à¸ˆà¸³à¹€à¸¥à¸¢à¹„à¸¡à¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™à¸•à¹‰à¸­à¸‡à¹„à¸›à¸¨à¸²à¸¥à¸à¹‡à¹„à¸”à¹‰ ğŸ˜‰`
  ],

  "A2": [
    `à¸«à¸¡à¸²à¸¢à¹€à¸£à¸µà¸¢à¸à¸à¸¢à¸²à¸™à¸šà¸¸à¸„à¸„à¸¥ à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸”à¹‰à¸£à¸±à¸šà¸«à¸¡à¸²à¸¢à¸ˆà¸°à¸•à¹‰à¸­à¸‡à¹„à¸›à¸¨à¸²à¸¥à¸•à¸²à¸¡à¸§à¸±à¸™à¹à¸¥à¸°à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸”à¹„à¸§à¹‰à¹ƒà¸™à¸«à¸¡à¸²à¸¢ à¹€à¸à¸·à¹ˆà¸­à¹€à¸šà¸´à¸à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸à¸¢à¸²à¸™à¸•à¹ˆà¸­à¸¨à¸²à¸¥ âš–ï¸`,
    `à¸«à¸²à¸à¸‚à¸±à¸”à¸‚à¸·à¸™à¹„à¸¡à¹ˆà¹„à¸›à¸¨à¸²à¸¥à¸•à¸²à¸¡à¸à¸³à¸«à¸™à¸” à¸¨à¸²à¸¥à¸­à¸²à¸ˆà¸­à¸­à¸à¸«à¸¡à¸²à¸¢à¸ˆà¸±à¸šà¹€à¸­à¸²à¸•à¸±à¸§à¸à¸±à¸à¸‚à¸±à¸‡à¹„à¸”à¹‰ à¹à¸¥à¸°à¸­à¸²à¸ˆà¸–à¸¹à¸à¸Ÿà¹‰à¸­à¸‡à¹„à¸”à¹‰ ğŸ˜®`
  ]
}

const gotLawsuit = id => {
  bot.sendTemplate({
    title: "à¸„à¸¸à¸“à¹„à¸”à¹‰à¸«à¸¡à¸²à¸¢à¸¨à¸²à¸¥à¸›à¸£à¸°à¹€à¸ à¸—à¹à¸à¹ˆà¸‡ à¸«à¸£à¸·à¸­à¸­à¸²à¸à¸²à¸„à¸£à¸±à¸š?",
    text: "à¹€à¸£à¸²à¸ˆà¸°à¸Šà¹ˆà¸§à¸¢à¸„à¸¸à¸“à¹à¸™à¹ˆà¹† à¸„à¸£à¸±à¸š à¹à¸•à¹ˆà¸£à¸šà¸à¸§à¸™à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸à¹ˆà¸­à¸™à¸™à¸°à¸„à¸£à¸±à¸š ğŸ™‚",
    actions: [{
      type: "postback",
      label: "à¸›à¸£à¸°à¹€à¸ à¸—à¸„à¸”à¸µà¹à¸à¹ˆà¸‡ âš–ï¸",
      data: "RektP"
    }, {
      type: "postback",
      label: "à¸›à¸£à¸°à¹€à¸ à¸—à¸„à¸”à¸µà¸­à¸²à¸à¸² ğŸ”ª",
      data: "RektA"
    }]
  }, id)
}

const e = (msg, m = 1) => {
  if (msg) {
    if (msg.length > m) {
      return true
    }
  }
  return false
}

const JOKES = [
  "à¸£à¹‰à¸­à¸¢à¸›à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§à¸™à¸µà¹ˆà¹€à¸‚à¸²à¹€à¸¥à¹ˆà¸™ April Fools Day à¸à¸±à¸™à¹à¸£à¸‡à¹€à¸™à¸²à¸° ğŸ™„",
  "à¸•à¸°à¸¡à¸¸à¸•à¸°à¸¡à¸´ ğŸ˜‰",
  "à¹€à¸”à¸µà¹‹à¸¢à¸§à¸—à¸¸à¹ˆà¸¡à¸”à¹‰à¸§à¸¢à¹‚à¸à¹€à¸”à¸µà¹‰à¸¢à¸¡ ğŸ™„",
  "à¸›à¸±à¹Šà¸”à¹‚à¸˜à¹ˆà¸§à¸§à¸§à¸§à¸§à¸§à¸§à¸§à¸§ ğŸ™„"
]

const JOKE_REPLY = {
  "à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸£à¸ˆà¸°à¸­à¸­à¸": "à¸„à¸™à¹„à¸—à¸¢à¸à¸²à¸à¸­à¸™à¸²à¸„à¸•à¹„à¸§à¹‰à¸à¸±à¸šà¸œà¸¡ à¹„à¸”à¹‰à¸¢à¸´à¸™à¸—à¸µà¹„à¸£à¸™à¹‰à¸³à¸•à¸²à¹„à¸«à¸¥à¸—à¸¸à¸à¸—à¸µ ğŸ˜‰",
  "à¸„à¸§à¸¢": "à¹€à¸”à¸µà¹ˆà¸¢à¸§à¸—à¸¸à¸¡à¸”à¹‰à¸§à¸¢à¹‚à¸à¹€à¸”à¸µà¹‰à¸¢à¸¡à¸«à¸£à¸­à¸ à¸›à¸±à¸—à¹‚à¸˜à¹ˆ ğŸ™„",
  "à¹€à¸ˆà¸­à¹„à¸”à¹‰à¸™à¸°à¸•à¸¹à¹ˆ": "à¸–à¹‰à¸²à¹€à¸šà¸·à¹ˆà¸­à¸œà¸¡à¸à¹‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸Šà¹ˆà¸­à¸‡ ğŸ™„",
  "à¹€à¸«à¹‡à¸šà¸«à¸¡à¸²": "à¹€à¸­à¸²à¹„à¸›à¸‚à¸²à¸¢à¸—à¸µà¹ˆà¸”à¸²à¸§à¸­à¸±à¸‡à¸„à¸²à¸£ à¸‚à¸²à¸¢à¹„à¸”à¹‰à¸£à¸²à¸„à¸²à¸”à¸µ ğŸ™„",
  "à¹€à¸šà¸·à¹ˆà¸­à¸•à¸¹à¹ˆ": "à¹„à¸«à¸™à¹ƒà¸„à¸£à¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸­à¸°à¹„à¸£ à¹„à¸›à¸„à¸¸à¸¢à¸à¸±à¸™à¸—à¸µà¹ˆà¸„à¹ˆà¸²à¸¢ ğŸ˜‰",
  "à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸›à¸£à¸°à¸Šà¸²à¸˜à¸´à¸›à¹„à¸•à¸¢": "à¹„à¸¡à¹ˆà¸­à¸­à¸ à¹ƒà¸„à¸£à¸ˆà¸°à¸­à¸­à¸ à¸œà¸¡à¹„à¸¡à¹ˆà¸­à¸­à¸ ğŸ™„",
  "à¸„à¸ªà¸Š à¸„à¸·à¸­à¹„à¸£": "à¸—à¸«à¸²à¸£à¸•à¸­à¸šà¹„à¸”à¹‰ à¸–à¸²à¸¡à¸›à¹ˆà¸²à¸§ ğŸ˜‰",
  "à¸•à¸°à¸¡à¸¸à¸•à¸°à¸¡à¸´": "à¸œà¸¡à¹€à¸à¸·à¹ˆà¸­à¸™à¹€à¸¥à¹ˆà¸™à¸„à¸¸à¸“à¹€à¸«à¸£à¸­ à¸—à¸¸à¹€à¸£à¸µà¸¢à¸™ ğŸ™„",
  "à¸›à¸£à¸°à¹€à¸—à¸¨à¸™à¸µà¹‰à¸‚à¸­à¸‡à¹ƒà¸„à¸£": "à¸‚à¸­à¸‡à¸œà¸¡à¸ˆà¸šà¸›à¸´à¹‰à¸‡ ğŸ˜‰",
  "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸¥à¸¸à¸‡": "à¹€à¸­à¸²à¸à¸­à¸‡à¹„à¸§à¹‰à¸•à¸£à¸‡à¸™à¸±à¹‰à¸™à¹à¸«à¸¥à¸° à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸¡à¸µà¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸à¸­à¸°à¹„à¸£ ğŸ˜‰",
  "à¸™à¸­à¸™à¸à¹ˆà¸­à¸™": "à¹€à¸ˆà¸£à¸´à¸à¸à¸£ à¸Šà¸´à¸•à¸±à¸‡à¹€à¸¡ à¹‚à¸›à¹‰à¸‡ à¸£à¸§à¸¢à¹† ğŸ˜‰"
}

/*
  Object.keys(o).forEach(e => {
    if ("namelol".match(e)) {
      console.log("WTF")
    }
  })
*/

const suggestLawyer = id => {
  setTimeout(() => {
    bot.sendTemplate({
      title: "à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸£à¸±à¸šà¸„à¸³à¸›à¸£à¸¶à¸à¸©à¸²à¸ˆà¸²à¸à¸—à¸™à¸²à¸¢à¸Ÿà¸£à¸µà¹„à¸«à¸¡à¸„à¸£à¸±à¸š ğŸ˜Š",
      text: "à¸„à¸”à¸µà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸—à¸™à¸²à¸¢à¸„à¸§à¸²à¸¡ à¹à¸¥à¸°à¹€à¸£à¸²à¸ˆà¸°à¸Šà¹ˆà¸§à¸¢à¸„à¸¸à¸“à¹ƒà¸«à¹‰à¸–à¸¶à¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸„à¸£à¸±à¸š ğŸ˜Š",
      thumbnail: "https://i.imgur.com/s4c7YSH.jpg",
      actions: [{
        type: "postback",
        label: "à¸«à¸²à¸—à¸™à¸²à¸¢à¹ƒà¸«à¹‰à¸«à¸™à¹ˆà¸­à¸¢à¸ªà¸´ ğŸ‘",
        data: "getlawyer"
      }, {
        type: "postback",
        label: "à¹„à¸¡à¹ˆ ğŸš«",
        data: "noneed"
      }]
    }, id)
  }, 800)
}

class WebHookHandler {
  find = () => Promise.resolve({data: "OK v4"})

  create = (data = {}) => {
    console.log("Incoming POST request:", JSON.stringify(data))

    // bot.sendText(`Incoming Msg: ${JSON.stringify(data)}`)

    if (data.events) {
      data.events.forEach(msg => {
        const id = msg.source.userId

        if (msg.type === "message") {
          const text = msg.message.text

          if (e(text.match(/à¸šà¸±à¸•à¸£|à¸›à¸£à¸°à¸Šà¸²/g))) {
            bot.sendText(`à¹€à¸­à¸à¸ªà¸²à¸£à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸•à¸£à¸µà¸¢à¸¡ à¸„à¸·à¸­ à¸šà¸±à¸•à¸£à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¸¢à¸·à¸™à¸¢à¸±à¸™à¸•à¸±à¸§à¸•à¸™à¸—à¸µà¹ˆà¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸£à¸±à¸à¸­à¸­à¸à¹ƒà¸«à¹‰ à¸«à¸£à¸·à¸­à¸ªà¸³à¹€à¸™à¸²à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸šà¹‰à¸²à¸™ ğŸ˜„`, id)
            // bot.sendImage(`https://i.imgur.com/z8C0ESs.jpg`, id)
          } else if (e(text.match(/à¸—à¸³|à¸à¸²à¸ªà¸›à¸­à¸£à¹Œà¸•|Passport/gi))) {
            bot.sendText(`à¸ˆà¸­à¸‡à¸„à¸´à¸§à¹à¸¥à¸°à¸”à¸¹à¸§à¸´à¸˜à¸µà¸à¸²à¸£à¸—à¸³à¸à¸²à¸ªà¸›à¸­à¸£à¹Œà¸•à¸—à¸µà¹ˆ https://www.passport.in.th ğŸ˜„`, id)
            bot.sendImage(`https://i.imgur.com/VRItpao.jpg`, id)
          } else if (text.match(/à¸«à¸¡à¸²à¸¢à¸¨à¸²à¸¥/g)) {
            gotLawsuit(id)
          } else if (text.match(/à¸šà¹‰à¸²à¸™à¸£à¸¸à¸à¸¥à¹‰à¸³/g)) {
            bot.sendText([
              `à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡à¸—à¸µà¹ˆà¸”à¸´à¸™à¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹€à¸­à¸²à¸„à¸·à¸™à¸—à¸µà¹ˆà¸”à¸´à¸™à¸ˆà¸²à¸à¹€à¸à¸·à¹ˆà¸­à¸™à¸šà¹‰à¸²à¸™à¸—à¸µà¹ˆà¸£à¸¸à¸à¸¥à¹‰à¸³à¹€à¸‚à¹‰à¸²à¸¡à¸²à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´ ğŸ’¡ (à¸›.à¸.à¸. à¸¡à¸²à¸•à¸£à¸² 1336)`,
              `à¸•à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸à¹ƒà¸«à¹‰à¹€à¸à¸·à¹ˆà¸­à¸™à¸šà¹‰à¸²à¸™à¸£à¸·à¹‰à¸­à¸–à¸­à¸™à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¸£à¸¸à¸à¸¥à¹‰à¸³ à¹à¸¥à¹‰à¸§à¸—à¸³à¸—à¸µà¹ˆà¸”à¸´à¸™à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸•à¸²à¸¡à¹€à¸”à¸´à¸¡ à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¸Šà¹ˆà¸§à¸¢à¸­à¸­à¸à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢à¹„à¸”à¹‰ ğŸ˜‰ (à¸›.à¸.à¸. à¸¡à¸²à¸•à¸£à¸² 1312 à¸§à¸£à¸£à¸„ 2)`
            ], id)
          } else if (text.match(/à¸«à¸™à¸µà¹‰à¸šà¸±à¸•à¸£à¹€à¸„à¸£à¸”à¸´à¸•/g)) {
            bot.sendText(REPLY.nomoney, id)
          } else if (text.match(/à¸•à¸³à¸£à¸§à¸ˆà¸¢à¸¶à¸”à¸£à¸–/g)) {
            bot.sendText(REPLY.policetookmycar, id)
          } else if (text.match(/à¹à¸­à¸šà¸–à¹ˆà¸²à¸¢/g)) {
            bot.sendText(REPLY.paparazzis, id)
          } else if (text.match(/à¸‚à¸­à¸šà¸„à¸¸à¸“|thank/gi)) {
            bot.sendText(`à¸‚à¸­à¸šà¸„à¸¸à¸“à¸¡à¸²à¸à¸„à¸£à¸±à¸š à¸›à¸µà¸«à¸™à¹‰à¸²à¹ƒà¸«à¹‰à¸œà¸¡à¹€à¸›à¹‡à¸™à¸™à¸²à¸¢à¸à¸•à¹ˆà¸­à¸”à¹‰à¸§à¸¢à¸™à¸° ğŸ˜‰`, id)
          } else if (text.match(/Never Gonna Give You Up/gi)) {
            bot.sendText(`Never Gonna Let You Down~! ğŸ˜‰`, id)
          } else if (text.match(/à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡à¸¨à¸²à¸¥/)) {
            bot.sendText(`à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡à¸¨à¸²à¸¥à¹„à¸”à¹‰à¸—à¸µà¹ˆ http://www.chawbanlaw.com/form_download.html à¸™à¸°à¸„à¸£à¸±à¸š~! ğŸ˜‰`, id)
          } else if (JOKE_REPLY[text]) {
            bot.sendText(JOKE_REPLY[text], id)
          } else if (text.match(/à¸ªà¸§à¸±à¸ªà¸”à¸µ|à¸«à¸§à¸±à¸”à¸”à¸µ|Hello|Hey|Hi|Yo/gi)) {
            initChat(id)
          } else {
            bot.sendText(JOKES[Math.floor(Math.random() * JOKES.length)], id)
          }
        }

        if (msg.type === "follow") {
          // User added you as a friend
          initChat(id)
        }

        if (msg.type === "postback") {
          const choice = msg.postback.data

          if (REPLY[choice]) {
            bot.sendText(REPLY[choice], id)

            if (choice.match(/P1|P2|A1|A2/g)) {
              suggestLawyer(id)
            }
          }

          if (choice === "getlawyer") {
            bot.sendText(`à¸—à¸™à¸²à¸¢à¸„à¸§à¸²à¸¡à¸‚à¸­à¸‡à¹€à¸£à¸²à¸à¸³à¸¥à¸±à¸‡à¸ˆà¸°à¸•à¸´à¸”à¸•à¹ˆà¸­à¹„à¸›à¸«à¸²à¸—à¹ˆà¸²à¸™ à¸‚à¸­à¹ƒà¸«à¹‰à¸—à¹ˆà¸²à¸™à¸Šà¸™à¸°à¸„à¸”à¸µà¸™à¸°à¸„à¸£à¸±à¸š ğŸ˜„`, id)
          }

          if (choice === "lawsuit") {
            gotLawsuit(id)
          }

          if (choice === "RektP") {
            bot.sendTemplate({
              title: "à¸£à¸šà¸à¸§à¸™à¸šà¸­à¸à¸›à¸£à¸°à¹€à¸ à¸—à¸‚à¸­à¸‡à¸«à¸¡à¸²à¸¢à¸¨à¸²à¸¥à¸„à¸”à¸µà¹à¸à¹ˆà¸‡à¸”à¹‰à¸§à¸¢à¸„à¸£à¸±à¸š âœŒï¸",
              text: "....",
              actions: [{
                type: "postback",
                label: "à¸«à¸¡à¸²à¸¢à¹€à¸£à¸µà¸¢à¸à¸„à¸”à¸µà¹à¸à¹ˆà¸‡à¸ªà¸²à¸¡à¸±à¸",
                data: "P1"
              }, {
                type: "postback",
                label: "à¸«à¸¡à¸²à¸¢à¹€à¸£à¸µà¸¢à¸à¸„à¸”à¸µà¸¡à¹‚à¸™à¸ªà¸²à¹€à¸«à¸£à¹ˆ",
                data: "P2"
              }]
            }, id)
          }

          if (choice === "RektA") {
            bot.sendTemplate({
              title: "à¸£à¸šà¸à¸§à¸™à¸šà¸­à¸à¸›à¸£à¸°à¹€à¸ à¸—à¸‚à¸­à¸‡à¸«à¸¡à¸²à¸¢à¸¨à¸²à¸¥à¸„à¸”à¸µà¸­à¸²à¸à¸²à¸”à¹‰à¸§à¸¢à¸„à¸£à¸±à¸š âœŒï¸",
              text: "....",
              actions: [{
                type: "postback",
                label: "à¸«à¸¡à¸²à¸¢à¸™à¸±à¸”à¹„à¸•à¹ˆà¸ªà¸§à¸™à¸¡à¸¹à¸¥à¸Ÿà¹‰à¸­à¸‡",
                data: "A1"
              }, {
                type: "postback",
                label: "à¸«à¸¡à¸²à¸¢à¹€à¸£à¸µà¸¢à¸à¸à¸¢à¸²à¸™à¸šà¸¸à¸„à¸„à¸¥",
                data: "A2"
              }]
            }, id)
          }

        }
      })
    }

    return Promise.resolve({data: "200"})
  }
}

export default function debug() {
  this.use("linehook", new WebHookHandler(), (req, res, next) => {
    res.status(200)
    next()
  })
}
